{% extends 'base.html' %}

{% block title %}Transactions - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="section-title">
                <i class="fas fa-exchange-alt"></i> Transactions
            </h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header" style="border-bottom: 2px solid var(--primary-color); padding: 20px;">
                    <h5 class="mb-0" style="color: #ffffff;">
                        <i class="fas fa-list"></i> All Transactions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" id="transactionsTable">
                        <p style="color: rgba(226, 232, 240, 0.5);">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header" style="border-bottom: 2px solid var(--primary-color); padding: 20px;">
                    <h5 class="mb-0" style="color: #ffffff;">
                        <i class="fas fa-plus-circle"></i> Add Transaction
                    </h5>
                </div>
                <div class="card-body">
                    <form id="transactionForm">
                        <div class="mb-3">
                            <label for="type" class="form-label" style="color: #ffffff;">Type</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="">Select Type</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label" style="color: #ffffff;">Category</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="amount" class="form-label" style="color: #ffffff;">Amount</label>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" required>
                        </div>

                        <div class="mb-3">
                            <label for="date" class="form-label" style="color: #ffffff;">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label" style="color: #ffffff;">Description</label>
                            <input type="text" class="form-control" id="description" name="description">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const expenseCategories = ['food', 'transport', 'utilities', 'entertainment', 'shopping', 'health', 'education', 'other'];
const incomeCategories = ['salary', 'freelance', 'investment', 'other'];

document.getElementById('type').addEventListener('change', (e) => {
    const categorySelect = document.getElementById('category');
    const categories = e.target.value === 'income' ? incomeCategories : expenseCategories;
    
    categorySelect.innerHTML = '<option value="">Select Category</option>' + 
        categories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
});

document.getElementById('date').valueAsDate = new Date();

document.getElementById('transactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        type: document.getElementById('type').value,
        category: document.getElementById('category').value,
        amount: document.getElementById('amount').value,
        date: document.getElementById('date').value,
        description: document.getElementById('description').value
    };
    
    try {
        const response = await fetch('/api/transactions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getAuthToken()
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            loadTransactions();
            alert('Transaction added successfully!');
        } else {
            showError('Failed to add transaction');
        }
    } catch (error) {
        showError(error.message);
    }
});

async function loadTransactions() {
    try {
        const response = await fetch('/api/transactions/');
        const transactions = await response.json();
        
        const container = document.getElementById('transactionsTable');
        
        if (transactions.length === 0) {
            container.innerHTML = '<p style="color: rgba(226, 232, 240, 0.5);">No transactions yet</p>';
            return;
        }
        
        const html = `
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${transactions.map(t => `
                        <tr>
                            <td>${new Date(t.date).toLocaleDateString()}</td>
                            <td>${t.category}</td>
                            <td><span class="badge badge-${t.type}">${t.type}</span></td>
                            <td style="color: ${t.type === 'income' ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 600;">
                                ${t.type === 'income' ? '+' : '-'}$${parseFloat(t.amount).toFixed(2)}
                            </td>
                            <td>${t.description || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${t.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading transactions:', error);
    }
}

async function deleteTransaction(id) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        try {
            const response = await fetch(`/api/transactions/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getAuthToken()
                }
            });
            
            if (response.ok) {
                loadTransactions();
            } else {
                showError('Failed to delete transaction');
            }
        } catch (error) {
            showError(error.message);
        }
    }
}

loadTransactions();
</script>
{% endblock %}
